BEGIN TRANSACTION;

-- Trigger to remove an orphaned tag after its last reference is deleted from variable_tags
-- Added in schema version 3
CREATE TRIGGER IF NOT EXISTS delete_orphan_tags_after_variable_tag_delete
AFTER DELETE ON variable_tags
FOR EACH ROW
BEGIN
    -- Check if the tag_id from the deleted row (OLD.tag_id)
    -- no longer exists in any other row in variable_tags
    DELETE FROM tags
    WHERE id = OLD.tag_id
    AND NOT EXISTS (
        SELECT 1 FROM variable_tags
        WHERE tag_id = OLD.tag_id
    );
END;

COMMIT;